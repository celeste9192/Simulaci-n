@model IEnumerable<PAWCP2.Models.ViewModels.FoodItemViewModel>
@{
    ViewData["Title"] = "Food Items";
    int roleId = ViewBag.RoleId is int rid ? rid : 3;
    string roleName = roleId == 1 ? "Admin" : roleId == 2 ? "Manager" : "Viewer";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Food Items</h2>
    <span class="badge @(roleId == 1 ? "bg-danger" : roleId == 2 ? "bg-warning text-dark" : "bg-secondary")">
        Rol: @roleName
    </span>
</div>

<div class="d-flex gap-2 align-items-center mb-3">
    <div class="flex-grow-1">
        <div class="input-group">
            <span class="input-group-text">🔎</span>
            <input id="q" type="text" class="form-control" placeholder="Search by name, category, brand, supplier, etc.">
        </div>
    </div>
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filtersModal">
        Filters
    </button>
</div>


<div class="modal fade" id="filtersModal" tabindex="-1" aria-labelledby="filtersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filtersModalLabel">Advanced Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="advancedSearchForm" method="get" asp-action="Index">
                <div class="modal-body row g-3">
             
                    <div class="col-md-4">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="Category">
                            <option value="">-- Select --</option>
                            @foreach (var cat in (IEnumerable<string>)ViewBag.Categories ?? Enumerable.Empty<string>())
                            {
                                <option value="@cat">@cat</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Brand</label>
                        <select class="form-select" name="Brand">
                            <option value="">-- Select --</option>
                            @foreach (var brand in (IEnumerable<string>)ViewBag.Brands ?? Enumerable.Empty<string>())
                            {
                                <option value="@brand">@brand</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Supplier</label>
                        <select class="form-select" name="Supplier">
                            <option value="">-- Select --</option>
                            @foreach (var sup in (IEnumerable<string>)ViewBag.Suppliers ?? Enumerable.Empty<string>())
                            {
                                <option value="@sup">@sup</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Min Price</label>
                        <input type="number" class="form-control" name="PriceMin" placeholder="₡">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Price</label>
                        <input type="number" class="form-control" name="PriceMax" placeholder="₡">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Calories</label>
                        <input type="number" class="form-control" name="CaloriesMax" placeholder="≤ X">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Expiration Date (after)</label>
                        <input type="date" class="form-control" name="ExpirationDate">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Perishable</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isPerishable" name="IsPerishable" value="true">
                            <label class="form-check-label" for="isPerishable">Yes</label>
                        </div>
                    </div>

     
                    <div class="col-md-4">
                        <label class="form-label">Status</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="IsActive" id="all" value="" checked>
                            <label class="form-check-label" for="all">All</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="IsActive" id="active" value="true">
                            <label class="form-check-label" for="active">Active</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="IsActive" id="inactive" value="false">
                            <label class="form-check-label" for="inactive">Inactive</label>
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="reset" form="advancedSearchForm" class="btn btn-outline-secondary">Clear</button>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table id="foodTable" class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Marca</th>
                <th>Precio</th>
                <th>Unidad</th>
                <th>Stock</th>
                <th>Vence</th>
                <th>Tipo</th>
                <th>Calorías</th>
                <th>Proveedor</th>
                <th>Barcode</th>
                <th>Rol</th>
                @if (roleId == 1 || roleId == 2)
                {
                    <th>Acciones</th>
                }
            </tr>
        </thead>
        <tbody>
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="@(roleId == 1 || roleId == 2 ? 14 : 13)" class="text-center text-muted py-4">No hay datos para mostrar.</td>
                </tr>
            }
            else
            {
                var i = 0;
                foreach (var it in Model)
                {
                    i++;
                    <tr class="@(it.IsActive.GetValueOrDefault() ? "" : "table-secondary text-decoration-line-through")">

                        <td>@i</td>
                        <td>
                            <div class="fw-semibold">@it.Name</div>
                            @if (!string.IsNullOrWhiteSpace(it.Description))
                            {
                                <div class="text-muted small">@it.Description</div>
                            }
                        </td>
                        <td>@it.Category</td>
                        <td>@it.Brand</td>
                        <td>₡ @it.Price.ToString("N2")</td>
                        <td>@it.Unit</td>
                        <td>
                            @if (roleId == 1 || roleId == 2)
                            {
                                <form asp-action="UpdateQuantity" method="post" class="d-flex align-items-center">
                                    <input type="hidden" name="id" value="@it.FoodItemId" />
                                    <input type="number" name="quantity" value="@it.QuantityInStock" min="0" class="form-control form-control-sm me-1" style="width:80px;" />
                                    <button type="submit" class="btn btn-sm btn-primary">💾</button>
                                </form>
                            }
                            else
                            {
                                @(it.QuantityInStock?.ToString("N0") ?? "-")
                            }
                        </td>
                        <td>@(it.ExpirationDate?.ToString("yyyy-MM-dd") ?? "—")</td>
                        <td>
                            @if (it.IsPerishable == true)
                            {
                                <span class="badge bg-warning text-dark">Perecedero</span>
                            }
                            else
                            {
                                <span class="badge bg-success">No perecedero</span>
                            }
                        </td>
                        <td>@(it.CaloriesPerServing?.ToString("N0") ?? "—")</td>
                        <td>@it.Supplier</td>
                        <td>@it.Barcode</td>
                        <td>
                            @{
                                var roleValue = it.RoleId ?? 3;
                                var rn = roleValue == 1 ? "Admin" : roleValue == 2 ? "Manager" : "Viewer";
                                var cls = roleValue == 1 ? "bg-danger" : roleValue == 2 ? "bg-warning text-dark" : "bg-secondary";
                            }
                            <span class="badge @cls">@rn</span>
                        </td>
                        @if (roleId == 1 || roleId == 2)
                        {
                            <td>
                                @if (it.QuantityInStock == 0)
                                {
                                    <form asp-action="Deactivate" method="post">
                                        <input type="hidden" name="id" value="@it.FoodItemId" />
                                        <button type="submit" class="btn btn-sm btn-danger">❌ Desactivar</button>
                                    </form>
                                }

                                @if (!it.IsActive.GetValueOrDefault())
                                {
                                    <form asp-action="Activate" method="post">
                                        <input type="hidden" name="id" value="@it.FoodItemId" />
                                        <button type="submit" class="btn btn-sm btn-success">✅ Activar</button>
                                    </form>
                                }

                                else
                                {
                                    <span class="text-muted small">—</span>
                                }
                            </td>
                        }
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        (function(){
            const q = document.getElementById('q');
            const table = document.getElementById('foodTable');
            if(!q || !table) return;

            q.addEventListener('input', function(){
                const term = (q.value || '').toLowerCase();
                for (const tr of table.tBodies[0].rows) {
                    const txt = tr.innerText.toLowerCase();
                    tr.style.display = txt.includes(term) ? '' : 'none';
                }
            });
        })();
    </script>
}
